


{% extends 'layout.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="mb-4">Actualizar Producto #{{ item_id }}</h2>
        
        {% include 'partials/_message.html' %}
        
        <div id="loadingSpinner" class="text-center my-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
        
        <form id="formUpdateItem" class="card card-body" style="display: none;">
            <input type="hidden" id="itemId" value="{{ item_id }}">
            
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" required>
            </div>
            
            <div class="mb-3">
                <label for="stock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="stock" name="stock" required min="0">
            </div>
            
            <div class="mb-3">
                <label for="precio" class="form-label">Precio</label>
                <input type="text" class="form-control" id="precio" name="precio" required>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Actualizar Producto
            </button>
            <a href="/" class="btn btn-secondary mt-2">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const itemId = document.getElementById('itemId').value;

    // Cargar datos del producto
    async function loadItem() {
        try {
            const response = await fetch(`/api/items/${itemId}`);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }
            
            // Rellenar formulario
            document.getElementById('nombre').value = result.data.nombre;
            document.getElementById('stock').value = result.data.stock;
            document.getElementById('precio').value = result.data.precio;
            
            // Mostrar formulario
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('formUpdateItem').style.display = 'block';
            
        } catch (error) {
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar producto: ${error.message}
                    <br><a href="/" class="btn btn-sm btn-secondary mt-2">Volver al inicio</a>
                </div>
            `;
        }
    }

    // Actualizar producto
    document.getElementById('formUpdateItem').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            nombre: document.getElementById('nombre').value.trim(),
            stock: parseInt(document.getElementById('stock').value),
            precio: document.getElementById('precio').value.trim()
        };
        
        try {
            const response = await fetch(`/api/items/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                sessionStorage.setItem('flashMessage', result.message);
                sessionStorage.setItem('flashType', 'success');
                window.location.href = '/';
            } else {
                showFlash(result.error, 'danger');
            }
            
        } catch (error) {
            showFlash('Error al actualizar producto: ' + error.message, 'danger');
        }
    });

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', loadItem);
</script>
{% endblock %}