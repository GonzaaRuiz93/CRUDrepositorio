
{% extends 'layout.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        
        
        {% include 'partials/_message.html' %}
        
        <!-- Spinner de carga -->
        <div id="loadingSpinner" class="text-center my-4">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-light mt-2">Cargando producto...</p>
        </div>
        
        <!-- Formulario de edición (mismo estilo que _forms.html) -->
        <form id="formUpdateItem" class="card bg-dark text-light" style="display: none;">
            <div class="card-body p-4">
                <h2 class="mb-4 text-light">Actualizar Producto #{{ item_id }}</h2>
                <input type="hidden" id="itemId" value="{{ item_id }}">
                
                <div class="mb-3">
                    <label for="nombre">Nombre del Producto</label>
                    <input 
                        type="text" 
                        id="nombre"
                        name="nombre" 
                        placeholder="Ej: Placa Madre" 
                        class="form-control rounded-0 bg-light border-0 text-dark" 
                        required
                    >
                </div>

                <div class="mb-3">
                    <label for="stock">Stock</label>
                    <input 
                        type="number" 
                        id="stock"
                        name="stock" 
                        placeholder="Ej: 20"
                        class="form-control rounded-0 bg-light border-0 text-dark"
                        min="0"
                        required
                    >
                </div>

                <div class="mb-3">
                    <label for="precio">Precio</label>
                    <input 
                        type="text" 
                        id="precio"
                        name="precio" 
                        placeholder="Ej: 200000.00 o 200000,00"
                        class="form-control rounded-0 bg-light border-0 text-dark"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-warning">
                    <span class="spinner-border spinner-border-sm d-none" id="btnSpinner"></span>
                    <span id="btnText">
                        <i class="bi bi-save"></i> Actualizar
                    </span>
                </button>
                
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>   
        </form>
    </div>
    <!--
    <div class="col-md-7">
         Puedes dejar esta columna vacía o agregar info adicional 
        <div class="card bg-dark text-light p-4">
            <h4><i class="bi bi-pencil-square"></i> Editando Producto #{{ item_id }}</h4>
            <p class="text-muted mb-0">Modifica los campos y presiona "Actualizar" para guardar los cambios.</p>
        </div>
    </div>-->
</div>
{% endblock %}

{% block scripts %}
<script>
    const itemId = document.getElementById('itemId').value;

    // Cargar datos del producto desde la API
    async function loadItem() {
        try {
            const response = await fetch(`/api/items/${itemId}`);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }
            
            // Rellenar formulario con los datos
            document.getElementById('nombre').value = result.data.nombre;
            document.getElementById('stock').value = result.data.stock;
            document.getElementById('precio').value = result.data.precio;
            
            // Ocultar spinner y mostrar formulario
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('formUpdateItem').style.display = 'block';
            
        } catch (error) {
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Error al cargar producto: ${error.message}
                    <br><br>
                    <a href="/" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver al inicio
                    </a>
                </div>
            `;
        }
    }

    // Actualizar producto con la API
    document.getElementById('formUpdateItem').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Deshabilitar botón y mostrar spinner
        const btn = e.target.querySelector('button[type="submit"]');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        btn.disabled = true;
        btnSpinner.classList.remove('d-none');
        btnText.innerHTML = ' Guardando...';
        
        const formData = {
            nombre: document.getElementById('nombre').value.trim(),
            stock: parseInt(document.getElementById('stock').value),
            precio: document.getElementById('precio').value.trim()
        };
        
        // Validación básica
        if (!formData.nombre || formData.stock < 0 || !formData.precio) {
            showFlash('Por favor completa todos los campos correctamente', 'danger');
            btn.disabled = false;
            btnSpinner.classList.add('d-none');
            btnText.innerHTML = '<i class="bi bi-save"></i> Actualizar';
            return;
        }
        
        try {
            const response = await fetch(`/api/items/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Guardar mensaje para mostrar en index
                sessionStorage.setItem('flashMessage', result.message);
                sessionStorage.setItem('flashType', 'success');
                window.location.href = '/';
            } else {
                showFlash(result.error, 'danger');
                btn.disabled = false;
                btnSpinner.classList.add('d-none');
                btnText.innerHTML = '<i class="bi bi-save"></i> Actualizar';
            }
            
        } catch (error) {
            showFlash('Error al actualizar producto: ' + error.message, 'danger');
            btn.disabled = false;
            btnSpinner.classList.add('d-none');
            btnText.innerHTML = '<i class="bi bi-save"></i> Actualizar';
        }
    });

    // Cargar datos al iniciar la página
    document.addEventListener('DOMContentLoaded', loadItem);
</script>
{% endblock %}